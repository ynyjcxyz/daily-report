<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æŠ¥åŠ©æ‰‹ V8.16</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* === V8.16 æ ·å¼ === */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 12px; background-color: #f2f4f8; color: #333; margin: 0; padding-bottom: 80px; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h3 { margin: 0; font-size: 18px; color: #222; }
        .lang-btn { background: #e1e1e1; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #555; cursor: pointer; }
        
        .input-panel { background: white; padding: 16px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .form-row { display: flex; gap: 12px; margin-bottom: 14px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 6px; }
        
        input { width: 100%; height: 44px; padding: 0 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #f9f9f9; -webkit-appearance: none; }
        input:focus { border-color: #007AFF; background: white; outline: none; }
        
        .grid-selector { display: grid; gap: 8px; margin-bottom: 15px; background: #f0f4f8; padding: 8px; border-radius: 10px; }
        .sku-grid { grid-template-columns: repeat(2, 1fr); }
        .box-grid { grid-template-columns: repeat(3, 1fr); }
        .fail-type-grid { grid-template-columns: repeat(3, 1fr); padding: 5px; background: transparent; margin-bottom: 5px; }

        .select-btn {
            background: white; border: 1px solid #cce0ff; color: #333; padding: 8px; border-radius: 8px;
            font-size: 13px; font-weight: 500; cursor: pointer; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 40px; user-select: none; transition: all 0.1s;
        }
        .select-btn:active { transform: scale(0.96); }
        .select-btn small { font-size: 10px; opacity: 0.6; margin-top: 2px; }
        .btn-highlight { background-color: #dbeeff !important; border-color: #007AFF !important; color: #007AFF !important; font-weight: bold; }

        .type-btn { border: 1px solid #ddd; color: #555; background: #fff; font-size: 12px; padding: 6px; border-radius: 20px; font-weight: bold; }
        .type-btn:active { background: #333; color: white; }

        .btn { border: none; height: 44px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; color: white; width: 100%; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:active { transform: scale(0.98); }
        .btn-add { background-color: #007AFF; flex: 2; }
        .btn-clear { background-color: #FF3B30; flex: 1; opacity: 0.8; }
        
        .action-bar { display: flex; gap: 10px; margin-top: 20px; }
        .btn-shot { background-color: #34C759; box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3); }
        .btn-copy { background-color: #5856D6; box-shadow: 0 4px 10px rgba(88, 86, 214, 0.3); }

        .preview-container { background: white; padding: 10px; border-radius: 4px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; color: #000; min-width: 100%; }
        th, td { border: 1px solid #999; padding: 6px 4px; text-align: center; vertical-align: middle; line-height: 1.3; }
        .header-bg { background-color: #D9E1F2; font-weight: bold; }
        .title-row { font-size: 14px; font-weight: bold; height: 30px; border: none; }
        .unfinished-input { border-left: 4px solid #FF9500; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <h3 id="ui-title">æ—¥æŠ¥åŠ©æ‰‹ V8.16</h3>
        <button class="lang-btn" onclick="toggleLang()">ğŸŒ ä¸­/En</button>
    </div>

    <div class="input-panel">
        
        <label id="lbl-sku-sel">ğŸ§ SKU é€‰æ‹©ï¼š</label>
        <div class="grid-selector sku-grid" id="sku-buttons"></div>
        <input type="hidden" id="sku">
        <div id="sku-display" style="text-align:center; color:#007AFF; font-weight:bold; margin-bottom:10px; height:20px; font-size:14px;"></div>

        <div class="form-row">
            <div style="flex:1">
                <label id="lbl-success">æˆåŠŸæ•°</label>
                <input type="number" id="successQty" placeholder="0" inputmode="numeric">
            </div>
            <div style="flex:1">
                <label id="lbl-stack">å †æ ˆå·</label>
                <input type="text" id="stack" placeholder="W5" value="W5">
            </div>
        </div>

        <label id="lbl-box-select">ğŸ“¦ è¿½åŠ ç®±å· (è‡ªåŠ¨åŠ X)ï¼š</label>
        <div class="grid-selector box-grid" id="box-buttons"></div>
        <div class="form-row">
            <div style="width:100%">
                <input type="text" id="boxInfo" placeholder="ç®±å·è®°å½•..." style="font-size:14px;">
            </div>
        </div>

        <label id="lbl-fail">âŒ æ··åˆå¤±è´¥è®°å½• (ç‚¹æŒ‰é’®æ’å…¥)ï¼š</label>
        <div class="grid-selector fail-type-grid">
            <div id="btn-tag-pkg" class="select-btn type-btn" onclick="insertTag('pkg')">ğŸ“¦ åŒ…è£…:</div>
            <div id="btn-tag-app" class="select-btn type-btn" onclick="insertTag('app')">ğŸ‘€ å¤–è§‚:</div>
            <div id="btn-tag-func" class="select-btn type-btn" onclick="insertTag('func')">âš™ï¸ åŠŸèƒ½:</div>
        </div>
        
        <div class="form-row">
            <div style="width:100%">
                <input type="text" id="failDesc" placeholder="ä¾‹å¦‚: å¤–è§‚:X3 é™ˆæ—§ï¼ŒåŒ…è£…:X1 æ‰åŒ…" style="font-size:14px;">
            </div>
        </div>

        <div class="form-row">
            <button id="btn-add" class="btn btn-add" onclick="addData()">â• æ·»åŠ è®°å½•</button>
            <button class="btn btn-clear" onclick="clearTable()">ğŸ—‘ï¸</button>
        </div>

        <label id="lbl-unfin-sel" style="margin-top:20px; border-top:1px dashed #ddd; padding-top:10px;">âš ï¸ æœªå®Œæˆ (ç‚¹å‡»è¿½åŠ )ï¼š</label>
        <div class="grid-selector sku-grid" id="unfin-sku-buttons" style="margin-bottom:5px;"></div>
        <input type="text" class="unfinished-input" id="unfinished" placeholder="æœªå®Œæˆ..." oninput="render()">
        
        <div class="action-bar">
            <button id="btn-shot" class="btn btn-shot" onclick="saveReportAsImage()">ğŸ“¸ å­˜é•¿å›¾</button>
            <button id="btn-copy" class="btn btn-copy" onclick="copyTextReport()">ğŸ“‹ å¤åˆ¶æ–‡å­—</button>
        </div>
    </div>

    <div id="lbl-preview" style="font-size:12px; color:#999; margin-bottom:5px;">ğŸ‘‡ é¢„è§ˆåŒº (ä¸‹ç­ç…§ç€æŠ„)</div>
    <div class="preview-container" id="capture-area">
        <table id="reportTable"></table>
    </div>
    
<script>
    // âš™ï¸ é…ç½®åŒº
    const SKU_DATA = [
        { code: "A3004Z11", name: "Q20i é»‘è‰²", name_en: "Q20i Black" },
        { code: "A3004Z21", name: "Q20i ç™½è‰²", name_en: "Q20i White" },
        { code: "A3004Z31", name: "Q20i è“è‰²", name_en: "Q20i Blue" },
        { code: "A3035Z11", name: "Space One é»‘è‰²", name_en: "Space One Black" },
        { code: "A3035Z31", name: "Space One è“è‰²", name_en: "Space One Blue" },
        { code: "A3028011", name: "Q30 é»‘è‰²", name_en: "Q30 Black" },
        { code: "A3028021", name: "Q30 ç™½è‰²", name_en: "Q30 White" },
        { code: "A3028031", name: "Q30 è“è‰²", name_en: "Q30 Blue" },
        { code: "A3028051", name: "Q30 ç²‰è‰²", name_en: "Q30 Pink" },
        { code: "A3025015", name: "Q20 é»‘è‰²", name_en: "Q20 Black" },
        { code: "A3025045", name: "Q20 é“¶è‰²", name_en: "Q20 Silver" },
        { code: "A3005ZA1", name: "Q11i é»‘è‰²", name_en: "Q11i Black" },
        { code: "A3062Z11", name: "Space One Pro é»‘è‰²", name_en: "Space One Pro Black" }
    ];
    
    const BOX_DATA = [
        { id: "1", size: "10*10" }, { id: "2", size: "16*12" }, { id: "3", size: "18*10" },
        { id: "4", size: "17*9" }, { id: "5", size: "18*14" }, { id: "6", size: "20*14" },
        { id: "7", size: "18*18" }, { id: "8", size: "17*17" }, { id: "9", size: "24*16" },
        { id: "10", size: "20*20" }, { id: "11", size: "18*14" }
    ];

    const TEXTS = {
        zh: { 
            title: "æ—¥æŠ¥åŠ©æ‰‹ V8.16", sku_sel: "ğŸ§ SKU é€‰æ‹©ï¼š", success: "æˆåŠŸæ•°", stack: "å †æ ˆå·", box_sel: "ğŸ“¦ è¿½åŠ ç®±å·ï¼š", fail: "âŒ æ··åˆå¤±è´¥è®°å½• (ç‚¹æŒ‰é’®æ’å…¥)ï¼š", add: "â• æ·»åŠ è®°å½•", shot: "ğŸ“¸ å­˜é•¿å›¾", copy: "ğŸ“‹ å¤åˆ¶æ–‡å­—", ph_box: "ä¾‹å¦‚: 2å·ç®±X10...", ph_fail: "å¤–è§‚:X3 é™ˆæ—§ï¼ŒåŒ…è£…:X1 æ‰åŒ…",
            tag_pkg: "ğŸ“¦ åŒ…è£…:", tag_app: "ğŸ‘€ å¤–è§‚:", tag_func: "âš™ï¸ åŠŸèƒ½:", preview: "ğŸ‘‡ é¢„è§ˆåŒº (ä¸‹ç­ç…§ç€æŠ„)",
            unfin_sel: "âš ï¸ æœªå®Œæˆ (ç‚¹å‡»è¿½åŠ ):", ph_unfin: "A3028011 X 20..."
        },
        en: { 
            title: "Report Helper V8.16", sku_sel: "ğŸ§ Select SKU:", success: "Success", stack: "Stack", box_sel: "ğŸ“¦ Append Box:", fail: "âŒ Mixed Failures (Tap to Insert):", add: "â• Add Row", shot: "ğŸ“¸ Save Img", copy: "ğŸ“‹ Copy Text", ph_box: "Box #2 X10...", ph_fail: "Appr:X3 Old, Pkg:X1 Fake",
            tag_pkg: "ğŸ“¦ Pkg:", tag_app: "ğŸ‘€ Appr:", tag_func: "âš™ï¸ Func:", preview: "ğŸ‘‡ Preview",
            unfin_sel: "âš ï¸ Unfinished (Tap to append):", ph_unfin: "A3028011 X 20..."
        }
    };
    
    const TABLE_TEXTS = {
        zh: { t_title: "ç¿»æ–°å·¥ä½œæ—¥æŠ¥", t_emp: "å‘˜å·¥", t_sku: "SKU", t_chn: "æ¸ é“", t_tot: "æ€»æ•°", t_suc: "æˆåŠŸ", t_fail: "æŠ¥åºŸ", t_reas: "å¤±è´¥åŸå› ", t_rem: "å¤‡æ³¨", t_pkg: "åŒ…è£…", t_app: "å¤–è§‚", t_fun: "åŠŸèƒ½", t_day: "å½“æ—¥å‡ºè´§", t_self: "è‡ªå­˜", t_cum: "ç´¯è®¡", t_unfin: "æœªå®Œæˆ" },
        en: { t_title: "Daily Report", t_emp: "Staff", t_sku: "SKU", t_chn: "CH", t_tot: "Total", t_suc: "OK", t_fail: "NG", t_reas: "Fail Reason", t_rem: "Remark", t_pkg: "Pkg", t_app: "Appr", t_fun: "Func", t_day: "Output", t_self: "Stock", t_cum: "Cumul", t_unfin: "Unfinished" }
    };

    let currentLang = 'zh';
    let records = [];

    (function init() {
        renderSkuButtons();
        renderBoxButtons();
        renderUnfinishedSkuButtons(); 
        updateUI(); render();
    })();

    function insertTag(type) {
        let tagName = "";
        if (currentLang === 'zh') {
            if (type === 'pkg') tagName = "åŒ…è£…"; if (type === 'app') tagName = "å¤–è§‚"; if (type === 'func') tagName = "åŠŸèƒ½";
        } else {
            if (type === 'pkg') tagName = "Pkg"; if (type === 'app') tagName = "Appr"; if (type === 'func') tagName = "Func";
        }
        
        const input = document.getElementById('failDesc');
        const prefix = `${tagName}:`;
        if (input.value.trim() !== "") {
            const val = input.value.trim();
            if (!val.endsWith('ï¼Œ') && !val.endsWith(',') && !val.endsWith(':')) {
                input.value += "ï¼Œ";
            }
        }
        input.value += prefix;
        input.focus();
    }

    function renderUnfinishedSkuButtons() {
        const container = document.getElementById('unfin-sku-buttons');
        container.innerHTML = '';
        SKU_DATA.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'select-btn'; 
            const displayName = currentLang === 'zh' ? item.name : (item.name_en || item.name);
            btn.innerHTML = `<span>${displayName}</span><small>${item.code}</small>`;
            btn.onclick = () => addToUnfinished(item);
            container.appendChild(btn);
        });
    }

    function addToUnfinished(item) {
        const input = document.getElementById('unfinished');
        const outputText = item.code; 
        if (input.value.trim() !== "") {
            const val = input.value.trim();
            if (!val.endsWith('ï¼Œ') && !val.endsWith(',')) {
                input.value += "ï¼Œ";
            }
        }
        input.value += `${outputText} X `;
        input.focus();
        render(); 
    }

    function renderSkuButtons() {
        const container = document.getElementById('sku-buttons');
        container.innerHTML = '';
        SKU_DATA.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'select-btn';
            btn.onclick = () => selectSku(item.code, item.name, btn);
            const displayName = currentLang === 'zh' ? item.name : (item.name_en || item.name);
            btn.innerHTML = `<span>${displayName}</span><small>${item.code}</small>`;
            container.appendChild(btn);
        });
    }

    function renderBoxButtons() {
        const container = document.getElementById('box-buttons');
        container.innerHTML = '';
        BOX_DATA.sort((a,b) => parseInt(a.id) - parseInt(b.id)).forEach(box => {
            const btn = document.createElement('div');
            btn.className = 'select-btn';
            btn.onclick = () => selectBox(box.id, btn);
            btn.innerHTML = `<span>#${box.id}</span><small>${box.size}</small>`;
            container.appendChild(btn);
        });
    }

    function selectSku(code, name, btnElem) {
        document.getElementById('sku').value = code;
        document.getElementById('sku-display').innerText = `å·²é€‰: ${name}`;
        document.querySelectorAll('#sku-buttons .select-btn').forEach(b => b.classList.remove('btn-highlight'));
        btnElem.classList.add('btn-highlight');
        document.getElementById('successQty').focus();
    }

    function selectBox(id, btnElem) {
        const input = document.getElementById('boxInfo');
        const prefix = currentLang === 'zh' ? 'å·ç®±' : ' Box';
        btnElem.classList.add('btn-highlight');
        setTimeout(() => btnElem.classList.remove('btn-highlight'), 150);
        if (input.value.trim() !== "" && !input.value.trim().endsWith('ï¼Œ')) input.value += "ï¼Œ";
        input.value += `${id}${prefix}X`;
        input.focus();
    }

    function toggleLang() { 
        currentLang = currentLang === 'zh' ? 'en' : 'zh'; 
        updateUI(); render(); 
        renderSkuButtons(); 
        renderUnfinishedSkuButtons(); 
    }
    
    function updateUI() {
        const t = TEXTS[currentLang];
        document.getElementById('ui-title').innerText = t.title; 
        document.getElementById('lbl-sku-sel').innerText = t.sku_sel; 
        document.getElementById('lbl-success').innerText = t.success; 
        document.getElementById('lbl-stack').innerText = t.stack; 
        document.getElementById('lbl-box-select').innerText = t.box_sel; 
        document.getElementById('lbl-fail').innerText = t.fail; 
        document.getElementById('btn-add').innerText = t.add; 
        document.getElementById('btn-shot').innerText = t.shot; 
        document.getElementById('btn-copy').innerText = t.copy; 
        document.getElementById('boxInfo').placeholder = t.ph_box; 
        document.getElementById('failDesc').placeholder = t.ph_fail;
        document.getElementById('lbl-preview').innerText = t.preview;
        document.getElementById('lbl-unfin-sel').innerText = t.unfin_sel;
        document.getElementById('unfinished').placeholder = t.ph_unfin;

        document.getElementById('btn-tag-pkg').innerText = t.tag_pkg;
        document.getElementById('btn-tag-app').innerText = t.tag_app;
        document.getElementById('btn-tag-func').innerText = t.tag_func;
    }

    function addData() {
        const sku = document.getElementById('sku').value;
        const success = parseInt(document.getElementById('successQty').value) || 0;
        const stack = document.getElementById('stack').value;
        let failDesc = document.getElementById('failDesc').value.trim().replace(/ï¼š/g, ':');
        const boxInfo = document.getElementById('boxInfo').value;
        
        if(!sku) { alert("Please select SKU"); return; }

        let f_pkg=0, f_app=0, f_func=0;
        let p_str="", a_str="", f_str="";

        const segments = failDesc.split(/[,ï¼Œ]/);
        segments.forEach(seg => {
            seg = seg.trim();
            if (!seg) return;
            let lowerSeg = seg.toLowerCase();
            let qty = 0;
            const numMatch = seg.match(/[xX]?(\d+)/);
            if (numMatch) qty = parseInt(numMatch[1]);

            let cleanText = seg.replace(/^(åŒ…è£…|å¤–è§‚|åŠŸèƒ½|Pkg|Appr|Func)[:\s]*/i, "");

            if (lowerSeg.startsWith('åŒ…è£…') || lowerSeg.startsWith('pkg')) {
                f_pkg += qty; p_str += (p_str?"ï¼Œ":"") + cleanText;
            } else if (lowerSeg.startsWith('åŠŸèƒ½') || lowerSeg.startsWith('func')) {
                f_func += qty; f_str += (f_str?"ï¼Œ":"") + cleanText;
            } else if (lowerSeg.startsWith('å¤–è§‚') || lowerSeg.startsWith('app')) {
                f_app += qty; a_str += (a_str?"ï¼Œ":"") + cleanText;
            } else {
                f_app += qty; a_str += (a_str?"ï¼Œ":"") + cleanText;
            }
        });
        
        const boxLabel = currentLang==='zh' ? 'ç®±å·' : 'Box';
        const stackLabel = currentLang==='zh' ? 'å †æ ˆ' : 'Stack';
        
        records.push({ 
            name: "John Young", sku, channel: "A", 
            success, fail: f_pkg+f_app+f_func, 
            f_pkg_str: p_str, f_app_str: a_str, f_func_str: f_str, 
            remark: `${boxLabel}: ${boxInfo}\n${stackLabel}: ${stack}` 
        });
        
        document.getElementById('successQty').value = '';
        document.getElementById('failDesc').value = '';
        document.getElementById('boxInfo').value = '';
        render();
    }

    function clearTable() { if(confirm("Clear?")) { records = []; document.getElementById('unfinished').value=''; render(); } }

    function render() {
        const tbl = document.getElementById('reportTable');
        const unfin = document.getElementById('unfinished').value;
        const t = TABLE_TEXTS[currentLang];
        let h = `<tr><td colspan="10" class="title-row" contenteditable="true">${t.t_title}</td></tr><tr><td rowspan="2" class="header-bg col-m">${t.t_emp}</td><td rowspan="2" class="header-bg col-m">${t.t_sku}</td><td rowspan="2" class="header-bg col-s">${t.t_chn}</td><td rowspan="2" class="header-bg col-s">${t.t_tot}</td><td rowspan="2" class="header-bg col-s">${t.t_suc}</td><td rowspan="2" class="header-bg col-s">${t.t_fail}</td><td colspan="3" class="header-bg">${t.t_reas}</td><td rowspan="2" class="header-bg col-l">${t.t_rem}</td></tr><tr><td class="header-bg col-s">${t.t_pkg}</td><td class="header-bg col-s">${t.t_app}</td><td class="header-bg col-s">${t.t_fun}</td></tr>`;
        if(records.length===0) h+=`<tr><td colspan="10" style="padding:20px;color:#ccc;font-size:12px">...</td></tr>`;
        else records.forEach(r => { h += `<tr><td contenteditable="true">${r.name}</td><td contenteditable="true">${r.sku}</td><td contenteditable="true">${r.channel}</td><td contenteditable="true">${r.success+r.fail}</td><td contenteditable="true" style="font-weight:bold">${r.success}</td><td contenteditable="true">${r.fail}</td><td contenteditable="true">${r.f_pkg_str}</td><td contenteditable="true">${r.f_app_str}</td><td contenteditable="true">${r.f_func_str}</td><td contenteditable="true" style="text-align:left;white-space:pre-wrap">${r.remark}</td></tr>`; });
        const sum = {}; records.forEach(r => { if(!sum[r.sku]) sum[r.sku]=0; sum[r.sku]+=r.success; });
        h += `<tr><td colspan="10" style="border:none;height:10px"></td></tr><tr><td class="header-bg">${t.t_sku}</td><td class="header-bg" colspan="2">${t.t_day}</td><td class="header-bg" colspan="3">${t.t_self}</td><td class="header-bg" colspan="4">${t.t_cum}</td></tr>`;
        for(let s in sum) h+= `<tr><td contenteditable="true">${s}</td><td contenteditable="true" colspan="2">${sum[s]}</td><td contenteditable="true" colspan="3"></td><td contenteditable="true" colspan="4"></td></tr>`;
        if(unfin || records.length>0) h+=`<tr><td colspan="10" style="border:none;height:10px"></td></tr><tr><td class="header-bg" colspan="2">${t.t_unfin}</td><td contenteditable="true" colspan="8" style="text-align:left;font-weight:bold;padding-left:10px">${unfin}</td></tr>`;
        tbl.innerHTML = h;
    }

    // ğŸš€ æ ¸å¿ƒå‡çº§ï¼šæˆªå›¾æ—¶å¼ºåˆ¶ä½¿ç”¨å®½å±æ¨¡å¼ (windowWidth: 800)
    function saveReportAsImage() {
        const element = document.getElementById("capture-area");
        // ä¸´æ—¶é”å®šå®½åº¦é˜²æ­¢å˜å½¢
        const originalWidth = element.style.width;
        
        html2canvas(element, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: "#ffffff", 
            // å…³é”®ï¼šå‘Šè¯‰ html2canvas å‡è£…å±å¹•å¾ˆå®½ï¼Œå¼ºåˆ¶æ¨ªå‘å¸ƒå±€
            windowWidth: 800, 
            onclone: (clonedDoc) => {
                // åœ¨å…‹éš†çš„æ–‡æ¡£é‡Œï¼Œå¼ºåˆ¶æŠŠè¡¨æ ¼æ‹‰å®½åˆ° 800pxï¼Œç¡®ä¿ä¸æ¢è¡Œ
                const clonedElement = clonedDoc.getElementById("capture-area");
                clonedElement.style.width = "800px";
                clonedElement.style.padding = "20px";
            }
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `WorkReport_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    function copyTextReport() {
        let text = "ğŸ“… " + (currentLang==='zh' ? "å·¥ä½œæ—¥æŠ¥" : "Daily Report") + "\n------------------\n";
        if(records.length === 0) { alert("No data"); return; }
        records.forEach(r => {
            text += `ğŸ”¹ ${r.sku} | OK:${r.success} | NG:${r.fail}\n`;
            if(r.f_pkg_str) text += `   [Pkg]: ${r.f_pkg_str}\n`;
            if(r.f_app_str) text += `   [App]: ${r.f_app_str}\n`;
            if(r.f_func_str) text += `   [Func]: ${r.f_func_str}\n`;
            text += `   ${r.remark.replace(/\n/g, " ")}\n`;
        });
        const unfin = document.getElementById('unfinished').value;
        if(unfin) text += `\nâš ï¸ Unfinished: ${unfin}`;
        navigator.clipboard.writeText(text).then(() => alert("Copied / å·²å¤åˆ¶"));
    }
</script>
</body>
</html>
