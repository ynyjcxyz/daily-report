<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æŠ¥åŠ©æ‰‹ V8.3 (å¤šç®±è¿½åŠ )</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* === V8.3 æ ·å¼ === */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 12px; background-color: #f2f4f8; color: #333; margin: 0; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        h3 { margin: 0; font-size: 18px; color: #222; }
        .lang-btn { background: #e1e1e1; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #555; cursor: pointer; }
        
        .input-panel { background: white; padding: 16px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .form-row { display: flex; gap: 12px; margin-bottom: 14px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 6px; }
        
        input, select { width: 100%; height: 44px; padding: 0 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #f9f9f9; -webkit-appearance: none; }
        input:focus { border-color: #007AFF; background: white; outline: none; }
        
        /* ç®±å·é€‰æ‹©å™¨æ ·å¼ (è°ƒæ•´ä¸ºç‚¹å‡»é—ªçƒ) */
        .box-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px;
            margin-bottom: 15px;
            background: #f0f4f8;
            padding: 10px;
            border-radius: 10px;
        }
        .box-btn {
            background: white;
            border: 1px solid #cce0ff;
            color: #0051ff;
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s; /* å¿«é€Ÿå“åº” */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none; /* é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡å­— */
        }
        .box-btn:active { background: #007AFF; color: white; transform: scale(0.95); }
        .box-btn span { display: block; }
        .box-id { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .box-size { font-size: 10px; opacity: 0.8; }

        .btn { border: none; height: 48px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; color: white; width: 100%; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-add { background-color: #007AFF; flex: 2; }
        .btn-clear { background-color: #FF3B30; flex: 1; opacity: 0.8; }
        .btn-shot { background-color: #34C759; margin-top: 20px; box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3); }
        
        .preview-header { font-size: 14px; color: #888; margin-bottom: 8px; font-weight: bold; }
        .preview-container { background: white; padding: 10px; border-radius: 4px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; color: #000; table-layout: fixed; min-width: 100%; }
        th, td { border: 1px solid #999; padding: 5px 2px; text-align: center; vertical-align: middle; word-break: break-all; line-height: 1.3; }
        .header-bg { background-color: #D9E1F2; font-weight: bold; }
        .title-row { font-size: 14px; font-weight: bold; height: 32px; border: none; text-align: center; }
        .col-s { width: 10%; } .col-m { width: 18%; } .col-l { width: 22%; }
        .unfinished-input { border-left: 4px solid #FF9500; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <h3 id="ui-title">æ—¥æŠ¥åŠ©æ‰‹ V8.3</h3>
        <button class="lang-btn" onclick="toggleLang()">ğŸŒ ä¸­/En</button>
    </div>

    <div class="input-panel">
        <div class="form-row">
            <div style="flex:2">
                <label id="lbl-sku">SKU</label>
                <input list="sku-options" id="sku" placeholder="A30..." autocomplete="off">
                <datalist id="sku-options"></datalist>
            </div>
            <div style="flex:1">
                <label id="lbl-success">æˆåŠŸæ•°</label>
                <input type="number" id="successQty" placeholder="0" inputmode="numeric">
            </div>
        </div>

        <div class="form-row">
            <div style="flex:1.5">
                <label id="lbl-fail">å¤±è´¥æè¿°</label>
                <input type="text" id="failDesc" placeholder="X3...">
            </div>
            <div style="flex:1">
                <label id="lbl-stack">å †æ ˆ</label>
                <input type="text" id="stack" placeholder="W5" value="W5">
            </div>
        </div>
        
        <label id="lbl-box-select" style="margin-top:10px">ğŸ“¦ ç‚¹å‡»å°ºå¯¸è¿½åŠ ç®±å·ï¼š</label>
        <div class="box-selector" id="box-buttons"></div>

        <div class="form-row">
            <div style="width:100%">
                <label id="lbl-box">ç®±å·è®°å½• (è¿½åŠ æ¨¡å¼)</label>
                <input type="text" id="boxInfo" placeholder="ä¾‹å¦‚: 2å·ç®±X10...">
            </div>
        </div>

        <div class="form-row">
            <button id="btn-add" class="btn btn-add" onclick="addData()">â• æ·»åŠ ä¸€è¡Œ</button>
            <button class="btn btn-clear" onclick="clearTable()">ğŸ—‘ï¸</button>
        </div>

        <input type="text" class="unfinished-input" id="unfinished" placeholder="æœªå®Œæˆ..." oninput="render()">
        
        <button id="btn-shot" class="btn btn-shot" onclick="saveReportAsImage()">ğŸ“¸ ä¿å­˜ä¸ºé•¿å›¾ç‰‡</button>
    </div>

    <div id="lbl-preview" class="preview-header">ğŸ‘‡ é¢„è§ˆåŒºåŸŸ (ç‚¹å‡»å¯ä¿®æ”¹)</div>
    
    <div class="preview-container" id="capture-area">
        <table id="reportTable"></table>
    </div>
    
<script>
    // âš™ï¸ ç®±å·æ•°æ®é…ç½®
    const BOX_DATA = [
        { id: "1", size: "10*10*10" },
        { id: "2", size: "16*12*6" },
        { id: "3", size: "18*10*10" },
        { id: "4", size: "17*9*13" },
        { id: "5", size: "18*14*12" },
        { id: "6", size: "20*14*14" },
        { id: "7", size: "18*18*14" },
        { id: "8", size: "17*17*17" },
        { id: "9", size: "24*16*14" },
        { id: "10", size: "20*20*20" },
        { id: "11", size: "18*14*10" }
    ];

    const MY_SKU_LIST = ["A3040031", "A3028031", "A3028011", "A3040011", "A3050022"];
    
    const TEXTS = {
        zh: { title: "æ—¥æŠ¥åŠ©æ‰‹ V8.3", sku: "SKU", success: "æˆåŠŸæ•°é‡", fail: "å¤±è´¥æè¿°", stack: "å †æ ˆå·", box_sel: "ğŸ“¦ ç‚¹å‡»å°ºå¯¸è¿½åŠ ç®±å·ï¼š", box: "ç®±å·è®°å½•", add: "â• æ·»åŠ ä¸€è¡Œ", shot: "ğŸ“¸ ä¿å­˜ä¸ºé•¿å›¾ç‰‡", preview: "ğŸ‘‡ é¢„è§ˆåŒºåŸŸ", ph_box: "2å·ç®±X10..." },
        en: { title: "Report Helper V8.3", sku: "SKU", success: "Success Qty", fail: "Fail Desc", stack: "Stack No.", box_sel: "ğŸ“¦ Tap Size to Append Box:", box: "Box Info", add: "â• Add Row", shot: "ğŸ“¸ Save Image", preview: "ğŸ‘‡ Preview", ph_box: "Box #2 X10..." }
    };
    
    const TABLE_TEXTS = {
        zh: { t_title: "ç¿»æ–°å·¥ä½œæ—¥æŠ¥", t_emp: "å‘˜å·¥", t_sku: "SKU", t_chn: "æ¸ é“", t_tot: "æ€»æ•°", t_suc: "æˆåŠŸ", t_fail: "æŠ¥åºŸ", t_reas: "å¤±è´¥åŸå› ", t_rem: "å¤‡æ³¨", t_pkg: "åŒ…è£…", t_app: "å¤–è§‚", t_fun: "åŠŸèƒ½", t_day: "å½“æ—¥å‡ºè´§æ•°é‡", t_self: "å‰©ä½™è‡ªå­˜æ•°é‡", t_cum: "å‰©ä½™ç´¯è®¡æ•°é‡", t_unfin: "å½“æ—¥é¢†å–æœªå®Œæˆæ•°é‡" },
        en: { t_title: "Refurbishment Daily Report", t_emp: "Staff", t_sku: "SKU", t_chn: "CH", t_tot: "Total", t_suc: "OK", t_fail: "NG", t_reas: "Fail Reason", t_rem: "Remark", t_pkg: "Pkg", t_app: "Appr", t_fun: "Func", t_day: "Daily Output", t_self: "Remaining Stock", t_cum: "Cumulative Stock", t_unfin: "Unfinished Tasks" }
    };

    let currentLang = 'zh';
    let records = [];

    (function init() {
        const dl = document.getElementById('sku-options');
        MY_SKU_LIST.forEach(s => { const op = document.createElement('option'); op.value = s; dl.appendChild(op); });
        renderBoxButtons();
        updateUI(); render();
    })();

    function renderBoxButtons() {
        const container = document.getElementById('box-buttons');
        const sortedBoxes = BOX_DATA.sort((a,b) => parseInt(a.id) - parseInt(b.id));
        
        sortedBoxes.forEach(box => {
            const btn = document.createElement('div');
            btn.className = 'box-btn';
            btn.onclick = () => selectBox(box.id, box.size, btn);
            btn.innerHTML = `<span class="box-size">${box.size}</span><span class="box-id">#${box.id}</span>`;
            container.appendChild(btn);
        });
    }

    // === V8.3 æ ¸å¿ƒä¿®æ”¹ï¼šè¿½åŠ æ¨¡å¼ ===
    function selectBox(id, size, btnElem) {
        const input = document.getElementById('boxInfo');
        const prefix = currentLang === 'zh' ? 'å·ç®±' : ' Box';
        const newText = `${id}${prefix}`;

        // é—ªçƒä¸€ä¸‹è§†è§‰åé¦ˆ
        const originalBg = btnElem.style.backgroundColor;
        btnElem.style.backgroundColor = '#dbeeff';
        setTimeout(() => { btnElem.style.backgroundColor = originalBg; }, 150);

        // é€»è¾‘ï¼šå¦‚æœè¾“å…¥æ¡†ä¸ä¸ºç©ºï¼Œä¸”æ²¡ç”¨é€—å·ç»“å°¾ï¼Œå°±è‡ªåŠ¨åŠ ä¸ªé€—å·
        if (input.value.trim() !== "") {
            const val = input.value.trim();
            const lastChar = val.slice(-1);
            if (lastChar !== 'ï¼Œ' && lastChar !== ',') {
                input.value += "ï¼Œ"; // æ™ºèƒ½è¡¥é€—å·
            }
        }
        
        input.value += newText;
        
        // å…³é”®ï¼šè‡ªåŠ¨èšç„¦ï¼Œæ–¹ä¾¿ç«‹åˆ»è¾“å…¥æ•°é‡ï¼ˆæ¯”å¦‚ X12ï¼‰
        input.focus();
    }

    function toggleLang() { currentLang = currentLang === 'zh' ? 'en' : 'zh'; updateUI(); render(); }

    function updateUI() {
        const t = TEXTS[currentLang];
        document.getElementById('ui-title').innerText = t.title; document.getElementById('lbl-sku').innerText = t.sku; document.getElementById('lbl-success').innerText = t.success; document.getElementById('lbl-fail').innerText = t.fail; document.getElementById('lbl-stack').innerText = t.stack; document.getElementById('lbl-box-select').innerText = t.box_sel; document.getElementById('lbl-box').innerText = t.box; document.getElementById('btn-add').innerText = t.add; document.getElementById('btn-shot').innerText = t.shot; document.getElementById('lbl-preview').innerText = t.preview; document.getElementById('boxInfo').placeholder = t.ph_box;
    }

    function addData() {
        const sku = document.getElementById('sku').value.trim().toUpperCase();
        const success = parseInt(document.getElementById('successQty').value) || 0;
        const stack = document.getElementById('stack').value;
        const failDesc = document.getElementById('failDesc').value;
        const boxInfo = document.getElementById('boxInfo').value;
        if(!sku) { document.getElementById('sku').focus(); return; }

        let f_pkg=0, f_app=0, f_func=0, p_str="", a_str="", f_str="";
        const matches = failDesc.match(/[xX]\d+/g);
        if (matches) {
            let total = 0; matches.forEach(m => total += parseInt(m.substring(1)));
            const lowDesc = failDesc.toLowerCase();
            if (lowDesc.includes("æ‰åŒ…") || lowDesc.includes("åŠŸèƒ½") || lowDesc.includes("fake") || lowDesc.includes("func")) { f_func = total; f_str = failDesc; } else if (lowDesc.includes("åŒ…è£…") || lowDesc.includes("box") || lowDesc.includes("pkg")) { f_pkg = total; p_str = failDesc; } else { f_app = total; a_str = failDesc; }
        }
        
        const boxLabel = currentLang==='zh' ? 'ç®±å·' : 'Box';
        const stackLabel = currentLang==='zh' ? 'å †æ ˆ' : 'Stack';
        
        records.push({ name: "John Young", sku, channel: "A", success, fail: f_pkg+f_app+f_func, f_pkg_str: p_str, f_app_str: a_str, f_func_str: f_str, remark: `${boxLabel}: ${boxInfo}\n${stackLabel}: ${stack}` });
        
        document.getElementById('sku').value = ''; 
        document.getElementById('successQty').value = ''; 
        document.getElementById('failDesc').value = ''; 
        document.getElementById('boxInfo').value = ''; 
        render();
    }

    function clearTable() { if(confirm("Clear all?")) { records = []; document.getElementById('unfinished').value=''; render(); } }

    function render() {
        const tbl = document.getElementById('reportTable');
        const unfin = document.getElementById('unfinished').value;
        const t = TABLE_TEXTS[currentLang];
        let h = `<tr><td colspan="10" class="title-row" contenteditable="true">${t.t_title}</td></tr><tr><td rowspan="2" class="header-bg col-m">${t.t_emp}</td><td rowspan="2" class="header-bg col-m">${t.t_sku}</td><td rowspan="2" class="header-bg col-s">${t.t_chn}</td><td rowspan="2" class="header-bg col-s">${t.t_tot}</td><td rowspan="2" class="header-bg col-s">${t.t_suc}</td><td rowspan="2" class="header-bg col-s">${t.t_fail}</td><td colspan="3" class="header-bg">${t.t_reas}</td><td rowspan="2" class="header-bg col-l">${t.t_rem}</td></tr><tr><td class="header-bg col-s">${t.t_pkg}</td><td class="header-bg col-s">${t.t_app}</td><td class="header-bg col-s">${t.t_fun}</td></tr>`;
        if(records.length===0) h+=`<tr><td colspan="10" style="padding:20px;color:#ccc;font-size:12px">...</td></tr>`;
        else records.forEach(r => { h += `<tr><td contenteditable="true">${r.name}</td><td contenteditable="true">${r.sku}</td><td contenteditable="true">${r.channel}</td><td contenteditable="true">${r.success+r.fail}</td><td contenteditable="true" style="font-weight:bold">${r.success}</td><td contenteditable="true">${r.fail}</td><td contenteditable="true">${r.f_pkg_str}</td><td contenteditable="true">${r.f_app_str}</td><td contenteditable="true">${r.f_func_str}</td><td contenteditable="true" style="text-align:left;white-space:pre-wrap">${r.remark}</td></tr>`; });
        const sum = {}; records.forEach(r => { if(!sum[r.sku]) sum[r.sku]=0; sum[r.sku]+=r.success; });
        h += `<tr><td colspan="10" style="border:none;height:10px"></td></tr><tr><td class="header-bg">${t.t_sku}</td><td class="header-bg" colspan="2">${t.t_day}</td><td class="header-bg" colspan="3">${t.t_self}</td><td class="header-bg" colspan="4">${t.t_cum}</td></tr>`;
        for(let s in sum) h+= `<tr><td contenteditable="true">${s}</td><td contenteditable="true" colspan="2">${sum[s]}</td><td contenteditable="true" colspan="3"></td><td contenteditable="true" colspan="4"></td></tr>`;
        if(unfin || records.length>0) h+=`<tr><td colspan="10" style="border:none;height:10px"></td></tr><tr><td class="header-bg" colspan="2">${t.t_unfin}</td><td contenteditable="true" colspan="8" style="text-align:left;font-weight:bold;padding-left:10px">${unfin}</td></tr>`;
        tbl.innerHTML = h;
    }

    function saveReportAsImage() {
        const element = document.getElementById("capture-area");
        html2canvas(element, {
            scale: 2, useCORS: true, backgroundColor: "#ffffff",
            windowHeight: element.scrollHeight, height: element.scrollHeight
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `WorkReport_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }
</script>
</body>
</html>
